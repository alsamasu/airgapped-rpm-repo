---
# ansible/playbooks/bootstrap_ssh_keys.yml
# Bootstrap SSH keys to managed hosts
#
# This playbook distributes SSH public keys to managed hosts
# for passwordless authentication.
#
# Usage:
#   ansible-playbook playbooks/bootstrap_ssh_keys.yml -k
#   (use -k to prompt for SSH password on first run)

- name: Bootstrap SSH keys to managed hosts
  hosts: managed_hosts
  gather_facts: false
  
  vars:
    ssh_key_path: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519.pub"
    ssh_key_type: ed25519
    
  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root
        
    - name: Check if SSH key file exists locally
      ansible.builtin.stat:
        path: "{{ ssh_key_path }}"
      delegate_to: localhost
      become: false
      register: ssh_key_stat
      
    - name: Generate SSH key if not present
      community.crypto.openssh_keypair:
        path: "{{ ssh_key_path | regex_replace('\\.pub$', '') }}"
        type: "{{ ssh_key_type }}"
        comment: "ansible@airgapped-rpm-repo"
      delegate_to: localhost
      become: false
      when: not ssh_key_stat.stat.exists
      
    - name: Read public key
      ansible.builtin.slurp:
        src: "{{ ssh_key_path }}"
      delegate_to: localhost
      become: false
      register: ssh_pubkey
      
    - name: Deploy SSH authorized key
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ ssh_pubkey.content | b64decode }}"
        
    - name: Verify SSH key authentication works
      ansible.builtin.ping:
      
    - name: Record host identity
      ansible.builtin.copy:
        content: "{{ airgap_host_id | default(ansible_machine_id | default(inventory_hostname)) }}"
        dest: /etc/airgap_host_id
        mode: '0644'
      when: airgap_host_id is defined
      
    - name: Display host identity
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} configured with ID: {{ airgap_host_id | default('machine-id fallback') }}"
