---
# ansible/roles/stig_audit/tasks/main.yml
# STIG audit configuration
#
# Configures auditd rules per RHEL STIG requirements.

- name: Ensure audit package is installed
  ansible.builtin.dnf:
    name: audit
    state: present
    
- name: Configure auditd.conf
  ansible.builtin.lineinfile:
    path: /etc/audit/auditd.conf
    regexp: "^{{ item.key }}\\s*="
    line: "{{ item.key }} = {{ item.value }}"
  loop:
    - { key: 'max_log_file', value: '50' }
    - { key: 'max_log_file_action', value: 'rotate' }
    - { key: 'num_logs', value: '5' }
    - { key: 'space_left_action', value: 'email' }
    - { key: 'admin_space_left_action', value: 'halt' }
    - { key: 'disk_full_action', value: 'halt' }
    - { key: 'disk_error_action', value: 'halt' }
  notify: Restart auditd
  
- name: Deploy STIG audit rules
  ansible.builtin.copy:
    content: |
      # STIG Audit Rules
      # Generated by Ansible STIG hardening
      
      # Delete all existing rules
      -D
      
      # Set buffer size
      -b 8192
      
      # Failure mode (1=printk, 2=panic)
      -f 1
      
      # Monitor user/group changes
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity
      
      # Monitor sudoers
      -w /etc/sudoers -p wa -k actions
      -w /etc/sudoers.d/ -p wa -k actions
      
      # Monitor SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd
      
      # Monitor authentication configuration
      -w /etc/pam.d/ -p wa -k pam
      -w /etc/nsswitch.conf -p wa -k nsswitch
      
      # Monitor time changes
      -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
      -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
      -a always,exit -F arch=b64 -S clock_settime -k time-change
      -a always,exit -F arch=b32 -S clock_settime -k time-change
      -w /etc/localtime -p wa -k time-change
      
      # Monitor network configuration
      -a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
      -a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
      -w /etc/issue -p wa -k system-locale
      -w /etc/issue.net -p wa -k system-locale
      -w /etc/hosts -p wa -k system-locale
      -w /etc/hostname -p wa -k system-locale
      
      # Monitor SELinux
      -w /etc/selinux/ -p wa -k MAC-policy
      
      # Monitor login/logout events
      -w /var/log/lastlog -p wa -k logins
      -w /var/run/faillock/ -p wa -k logins
      -w /var/log/tallylog -p wa -k logins
      
      # Monitor session initiation
      -w /var/run/utmp -p wa -k session
      -w /var/log/wtmp -p wa -k logins
      -w /var/log/btmp -p wa -k logins
      
      # Monitor privileged commands
      -a always,exit -F path=/usr/bin/sudo -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged
      -a always,exit -F path=/usr/bin/su -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged
      -a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged
      
      # Monitor file deletion by users
      -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
      -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
      
      # Monitor kernel module operations
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules
      -a always,exit -F arch=b64 -S init_module -S delete_module -k modules
      
      # Make configuration immutable (must be last)
      -e 2
    dest: "{{ stig_audit_rules_file }}"
    mode: '0640'
    owner: root
    group: root
  notify: Restart auditd
  
- name: Load audit rules
  ansible.builtin.command: augenrules --load
  changed_when: false
  ignore_errors: true

handlers:
  - name: Restart auditd
    ansible.builtin.command: service auditd restart
    # auditd cannot be restarted via systemctl
