# containers/ansible-ee/Containerfile
# Ansible Execution Environment for Airgapped RPM Repository
#
# This container provides Ansible automation capabilities for:
# - SSH key bootstrap to managed hosts
# - Repository client configuration
# - Package manifest collection
# - Monthly security patching
# - STIG hardening with syslog TLS forwarding
#
# Build context should be the project root:
#   podman build -t airgap-ansible-control:latest -f containers/ansible-ee/Containerfile .

FROM registry.access.redhat.com/ubi9/ubi:latest

LABEL maintainer="RPM Repository Team"
LABEL description="Ansible Execution Environment for Airgapped Infrastructure"

# Install Ansible and dependencies
RUN dnf install -y \
    python3 \
    python3-pip \
    python3-devel \
    openssh-clients \
    sshpass \
    rsync \
    jq \
    openssl \
    && dnf clean all \
    && rm -rf /var/cache/dnf

# Install Ansible and required collections via pip
RUN pip3 install --no-cache-dir \
    ansible-core>=2.15 \
    ansible-runner \
    jmespath \
    netaddr

# Install Ansible collections
RUN ansible-galaxy collection install \
    ansible.posix \
    community.general \
    community.crypto

# Create ansible user and directories
RUN useradd -r -u 1001 -g 0 -d /runner -s /bin/bash ansible \
    && mkdir -p /runner/project /runner/inventory /runner/artifacts \
    && mkdir -p /runner/.ssh \
    && mkdir -p /etc/ansible \
    && chown -R 1001:0 /runner \
    && chmod -R g=u /runner \
    && chmod 700 /runner/.ssh

# Copy Ansible configuration
COPY containers/ansible-ee/ansible.cfg /etc/ansible/ansible.cfg

# Copy project files (playbooks and roles)
COPY --chown=1001:0 ansible/playbooks/ /runner/project/playbooks/
COPY --chown=1001:0 ansible/roles/ /runner/project/roles/
COPY --chown=1001:0 ansible/inventories/ /runner/inventory/

# Environment variables
ENV ANSIBLE_CONFIG=/etc/ansible/ansible.cfg \
    ANSIBLE_HOST_KEY_CHECKING=False \
    RUNNER_PLAYBOOK=/runner/project/playbooks/site.yml

# Working directory
WORKDIR /runner

# Run as non-root user
USER 1001

# Default command - run ansible-runner
CMD ["ansible-runner", "run", "/runner", "-p", "site.yml"]
