#version=RHEL9
# Kickstart for Capsule Server (Internal, Disconnected/Airgapped)
# RHEL 9.6, Multi-disk configuration for Capsule requirements
#
# Disk Layout:
#   sda: OS (50GB)
#   sdb: /var/lib/pulp (300GB for content cache)
#
# Reference: https://access.redhat.com/documentation/en-us/red_hat_satellite

text
cdrom
keyboard --xlayouts='us'
lang en_US.UTF-8

network --bootproto=dhcp --device=link --activate --onboot=yes
network --hostname=capsule-internal

# Credentials (replaced by operator.ps1 from spec.yaml)
rootpw --plaintext ChangeMe123!
user --name=admin --password=ChangeMe123! --plaintext --groups=wheel

timezone America/New_York --utc
bootloader --location=mbr
zerombr
clearpart --all --initlabel --disklabel=gpt

# Disk 1: OS
part /boot/efi --fstype="efi" --ondisk=sda --size=600
part /boot --fstype="xfs" --ondisk=sda --size=1024
part pv.os --fstype="lvmpv" --ondisk=sda --size=1 --grow

volgroup vg_os pv.os
logvol / --fstype="xfs" --size=25000 --name=lv_root --vgname=vg_os
logvol /var --fstype="xfs" --size=15000 --name=lv_var --vgname=vg_os
logvol /var/log --fstype="xfs" --size=10000 --name=lv_varlog --vgname=vg_os
logvol /var/log/audit --fstype="xfs" --size=5000 --name=lv_audit --vgname=vg_os
logvol /home --fstype="xfs" --size=5000 --name=lv_home --vgname=vg_os
logvol /tmp --fstype="xfs" --size=5000 --name=lv_tmp --vgname=vg_os
logvol swap --fstype="swap" --size=16384 --name=lv_swap --vgname=vg_os

# Disk 2: Pulp content storage handled in %post

skipx
services --enabled="chronyd,sshd"
firewall --enabled --service=ssh --port=80/tcp --port=443/tcp --port=5647/tcp --port=8000/tcp --port=8140/tcp --port=9090/tcp
selinux --enforcing
reboot --eject

%packages
@^minimal-environment
@standard
chrony
openssh-server
vim-enhanced
wget
curl
bash-completion
sos
rsync
%end

%post --log=/root/ks-post.log
#!/bin/bash
set -x

# Set hostname
hostnamectl set-hostname capsule-internal

# Configure SSH
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Passwordless sudo for wheel group (initial setup only)
echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel-nopasswd

# Mark this system as Capsule server
echo "capsule" > /etc/airgap-role

# Configure second disk for Pulp if it exists
if [ -b /dev/sdb ]; then
    echo "Configuring /dev/sdb for Pulp content storage..."
    pvcreate /dev/sdb
    vgcreate vg_pulp /dev/sdb
    lvcreate -l 100%FREE -n lv_pulp vg_pulp
    mkfs.xfs /dev/vg_pulp/lv_pulp
    mkdir -p /var/lib/pulp
    echo "/dev/vg_pulp/lv_pulp /var/lib/pulp xfs defaults 0 0" >> /etc/fstab
    mount /var/lib/pulp
fi

# Prepare Capsule prerequisite directories
mkdir -p /var/lib/pulp
mkdir -p /var/lib/pulp/imports
mkdir -p /var/lib/pulp/verified
chmod 755 /var/lib/pulp

# System tuning for Capsule
cat >> /etc/sysctl.d/99-capsule.conf << 'SYSCTL'
# Capsule performance tuning
fs.aio-max-nr = 1048576
net.core.somaxconn = 4096
vm.swappiness = 10
SYSCTL

# Create import staging directory structure
mkdir -p /srv/airgap/bundles/incoming
mkdir -p /srv/airgap/bundles/verified
mkdir -p /srv/airgap/certs
mkdir -p /srv/airgap/ansible
chmod -R 755 /srv/airgap

# Create marker for first boot scripts
touch /var/lib/airgap-capsule-pending-setup

echo "Capsule base installation complete. Run capsule-installer after bundle import."
%end

%addon com_redhat_kdump --disable
%end
