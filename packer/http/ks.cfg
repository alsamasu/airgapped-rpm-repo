# RHEL 9.6 Kickstart for Internal RPM Repository Publisher
# Automated installation configuration

# Installation mode
text
skipx
eula --agreed

# Keyboard and language
keyboard --xlayouts='us'
lang en_US.UTF-8

# Timezone
timezone UTC --utc --ntpservers=0.rhel.pool.ntp.org,1.rhel.pool.ntp.org

# Network configuration (DHCP by default)
network --bootproto=dhcp --device=link --activate --onboot=yes
network --hostname=internal-publisher

# Root password (will be changed on first boot)
rootpw --iscrypted $6$rounds=4096$randomsalt$hashedpassword

# System authorization
authselect select sssd with-mkhomedir --force

# Firewall configuration
firewall --enabled --service=ssh --port=8080:tcp,8443:tcp

# SELinux
selinux --enforcing

# Services
services --enabled=sshd,chronyd,firewalld

# System bootloader
bootloader --append="console=tty0 console=ttyS0,115200n8 crashkernel=auto" --location=mbr --boot-drive=sda

# Disk partitioning
zerombr
clearpart --all --initlabel --drives=sda
ignoredisk --only-use=sda,sdb

# Partitioning for OS disk (sda)
part /boot/efi --fstype=efi --size=600 --ondisk=sda
part /boot --fstype=xfs --size=1024 --ondisk=sda
part pv.01 --fstype=lvmpv --size=1 --grow --ondisk=sda

# LVM for OS
volgroup vg_root --pesize=4096 pv.01
logvol / --fstype=xfs --name=lv_root --vgname=vg_root --size=20480
logvol /var --fstype=xfs --name=lv_var --vgname=vg_root --size=10240
logvol /var/log --fstype=xfs --name=lv_varlog --vgname=vg_root --size=5120
logvol /var/log/audit --fstype=xfs --name=lv_audit --vgname=vg_root --size=2048
logvol /home --fstype=xfs --name=lv_home --vgname=vg_root --size=2048 --fsoptions="nodev,nosuid"
logvol /tmp --fstype=xfs --name=lv_tmp --vgname=vg_root --size=2048 --fsoptions="nodev,nosuid,noexec"
logvol swap --fstype=swap --name=lv_swap --vgname=vg_root --size=4096

# Data disk will be configured in post-install (sdb)

# Packages
%packages --ignoremissing
@^minimal-environment
@standard
@headless-management
bash-completion
chrony
curl
dnf-utils
firewalld
git
gnupg2
jq
openssh-server
openscap
openscap-scanner
podman
rsync
scap-security-guide
tar
tmux
vim-enhanced
wget
# Remove unnecessary packages
-iwl*-firmware
-plymouth*
%end

# Addon for security
%addon com_redhat_oscap
    content-type = scap-security-guide
    profile = xccdf_org.ssgproject.content_profile_stig
%end

# Post-installation script
%post --log=/root/ks-post.log

# Update all packages
dnf update -y

# Configure data disk (sdb) for /data
if [ -b /dev/sdb ]; then
    parted /dev/sdb mklabel gpt
    parted /dev/sdb mkpart primary xfs 0% 100%
    mkfs.xfs -L data /dev/sdb1
    mkdir -p /data
    echo "LABEL=data /data xfs defaults 0 2" >> /etc/fstab
    mount /data
fi

# Create directory structure
mkdir -p /data/bundles/{incoming,verified,archive}
mkdir -p /data/repos
mkdir -p /data/lifecycle/{dev,prod}
mkdir -p /data/keys/.gnupg
mkdir -p /data/client-config
mkdir -p /var/log/rpmserver
chmod 700 /data/keys/.gnupg

# Create service account
useradd -r -m -d /opt/rpmserver -s /sbin/nologin rpmserver
chown -R rpmserver:rpmserver /data /var/log/rpmserver

# Configure SSH
sed -i 's/#PermitRootLogin yes/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Enable and configure firewall
systemctl enable firewalld
firewall-offline-cmd --add-port=8080/tcp
firewall-offline-cmd --add-port=8443/tcp
firewall-offline-cmd --add-service=ssh

# Set up motd
cat > /etc/motd << 'MOTD'
===============================================================================
                    INTERNAL RPM REPOSITORY PUBLISHER
                         Airgapped Environment

  This system serves RPM packages to internal RHEL hosts.
  Authorized access only. All activity is monitored and logged.

  Repository URL: http://[hostname]:8080/repos/
  Documentation:  /opt/rpmserver/docs/

===============================================================================
MOTD

# Configure audit rules
cat >> /etc/audit/rules.d/99-custom.rules << 'AUDIT'
# Log all commands executed as root
-a always,exit -F arch=b64 -F euid=0 -S execve -k root_commands
-a always,exit -F arch=b32 -F euid=0 -S execve -k root_commands

# Log changes to system files
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/sudoers -p wa -k sudo_changes

# Log repository changes
-w /data/repos -p wa -k repo_changes
-w /data/bundles -p wa -k bundle_changes
AUDIT

# Create systemd service for internal publisher
cat > /etc/systemd/system/rpmserver.service << 'SERVICE'
[Unit]
Description=Internal RPM Repository Publisher
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/rpmserver
ExecStart=/usr/bin/podman run --rm \
    --name rpmserver \
    -p 8080:8080 \
    -v /data:/data:Z \
    -v /var/log/rpmserver:/var/log/rpmserver:Z \
    localhost/airgapped-rpm-repo:internal
ExecStop=/usr/bin/podman stop rpmserver
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE

systemctl daemon-reload

# Set correct SELinux context
semanage fcontext -a -t httpd_sys_content_t "/data(/.*)?"
semanage fcontext -a -t httpd_log_t "/var/log/rpmserver(/.*)?"
restorecon -Rv /data /var/log/rpmserver 2>/dev/null || true

# Final cleanup
dnf clean all
rm -rf /var/cache/dnf/*

%end

# Reboot after installation
reboot
