# testdata/ssh-host-ubi8/Containerfile
# SSH-enabled AlmaLinux 8 test container

FROM almalinux:8

LABEL maintainer="RPM Repository Team"
LABEL description="SSH-enabled AlmaLinux 8 test host"

# Install SSH server and Python 3.11 for Ansible 2.17+ compatibility
RUN dnf install -y --setopt=tsflags=nodocs --allowerasing \
    openssh-server openssh-clients sudo python3 python3.11 \
    rsyslog rsyslog-gnutls procps-ng iproute curl nmap-ncat \
    && dnf clean all && rm -rf /var/cache/dnf

# Set Python 3.11 as default for Ansible compatibility
RUN alternatives --set python3 /usr/bin/python3.11 2>/dev/null || \
    alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 2>/dev/null || true

# Configure SSH
RUN ssh-keygen -A \
    && sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/" /etc/ssh/sshd_config \
    && sed -i "s/#PasswordAuthentication.*/PasswordAuthentication yes/" /etc/ssh/sshd_config \
    && sed -i "s/#PubkeyAuthentication.*/PubkeyAuthentication yes/" /etc/ssh/sshd_config \
    && mkdir -p /root/.ssh && chmod 700 /root/.ssh

RUN echo "root:testpassword" | chpasswd

RUN useradd -m -s /bin/bash testuser \
    && echo "testuser:testpassword" | chpasswd \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

RUN mkdir -p /etc/yum.repos.d /etc/pki/rpm-gpg
RUN systemd-machine-id-setup 2>/dev/null || uuidgen > /etc/machine-id

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 22

HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=3 \
    CMD pgrep sshd || exit 1

ENTRYPOINT ["/entrypoint.sh"]
