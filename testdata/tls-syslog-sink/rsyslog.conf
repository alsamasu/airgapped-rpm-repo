# rsyslog.conf - TLS Syslog Sink configuration
#
# Receives syslog messages over TLS (server-auth only, no client certs)
# and plain TCP for testing.

# Load required modules
module(load="imtcp")
module(load="imptcp" threads="2")

# GnuTLS driver for TLS
global(
    DefaultNetstreamDriver="gtls"
    DefaultNetstreamDriverCAFile="/etc/pki/rsyslog/ca.crt"
    DefaultNetstreamDriverCertFile="/etc/pki/rsyslog/server.crt"
    DefaultNetstreamDriverKeyFile="/etc/pki/rsyslog/server.key"
)

# TLS input on port 6514 (server-auth only, no client certs required)
input(
    type="imptcp"
    port="6514"
    StreamDriver.Name="gtls"
    StreamDriver.Mode="1"
    StreamDriver.AuthMode="anon"
)

# Plain TCP input on port 514 (for testing without TLS)
input(
    type="imtcp"
    port="514"
)

# Templates
template(name="RemoteFilePath" type="string"
    string="/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log")

template(name="JSONFormat" type="string"
    string="{\"timestamp\":\"%timegenerated:::date-rfc3339%\",\"host\":\"%HOSTNAME%\",\"program\":\"%PROGRAMNAME%\",\"severity\":\"%syslogseverity-text%\",\"message\":\"%msg:::json%\"}\n")

# Write all received logs to remote directory
*.* action(
    type="omfile"
    dynaFile="RemoteFilePath"
    template="RSYSLOG_TraditionalFileFormat"
    dirCreateMode="0755"
    fileCreateMode="0644"
)

# Also write JSON format for easy parsing
*.* action(
    type="omfile"
    file="/var/log/remote/all.json"
    template="JSONFormat"
)

# Console output for debugging
*.* action(type="omstdout" template="RSYSLOG_TraditionalFileFormat")
